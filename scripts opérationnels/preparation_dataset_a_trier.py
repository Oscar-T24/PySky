
import csv
from indice import determine_weather_index
from tronque import tronquer
import requests
from PIL import Image
from io import BytesIO
import numpy
import re
import time
import pandas as pd
import json
import cv2

from geopy.geocoders import Nominatim
import re

global dico_etats_meteos


dico_etats_meteos = [{'Code': '01', 'coordonnees': ['[49.453285449999996, 3.606899003594057]'], 'temperatures': 5}, {'Code': '01', 'coordonnees': ['[49.453285449999996, 3.606899003594057]'], 'temperatures': 5}, {'Code': '01', 'coordonnees': ['[49.453285449999996, 3.606899003594057]'], 'temperatures': 5}, {'Code': '01', 'coordonnees': ['[49.453285449999996, 3.606899003594057]'], 'temperatures': 5}, {'Code': '01', 'coordonnees': ['[49.453285449999996, 3.606899003594057]'], 'temperatures': 5}, {'Code': '02', 'coordonnees': ['[49.453285449999996, 3.606899003594057]'], 'temperatures': 5}, {'Code': '03', 'coordonnees': ['[46.36746405, 3.163882848311948]'], 'temperatures': 5}, {'Code': '03', 'coordonnees': ['[46.36746405, 3.163882848311948]'], 'temperatures': 5}, {'Code': '04', 'coordonnees': ['[44.1640832, 6.187851538609079]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '05', 'coordonnees': ['[44.6564666, 6.352024584507948]'], 'temperatures': 5}, {'Code': '06', 'coordonnees': ['[43.9210587, 7.1790785]'], 'temperatures': 5}, {'Code': '06', 'coordonnees': ['[43.9210587, 7.1790785]'], 'temperatures': 5}, {'Code': '06', 'coordonnees': ['[43.9210587, 7.1790785]'], 'temperatures': 5}, {'Code': '06', 'coordonnees': ['[43.9210587, 7.1790785]'], 'temperatures': 5}, {'Code': '06', 'coordonnees': ['[43.9210587, 7.1790785]'], 'temperatures': 5}, {'Code': '07', 'coordonnees': ['[44.815194000000005, 4.3986524702343965]'], 'temperatures': 5}, {'Code': '07', 'coordonnees': ['[44.815194000000005, 4.3986524702343965]'], 'temperatures': 5}, {'Code': '08', 'coordonnees': ['[49.69801175, 4.671600518245179]'], 'temperatures': 5}, {'Code': '09', 'coordonnees': ['[42.9455368, 1.4065544156065486]'], 'temperatures': 5}, {'Code': '09', 'coordonnees': ['[42.9455368, 1.4065544156065486]'], 'temperatures': 5}, {'Code': '11', 'coordonnees': ['[43.0542733, 2.512471457499548]'], 'temperatures': 5}, {'Code': '11', 'coordonnees': ['[43.0542733, 2.512471457499548]'], 'temperatures': 5}, {'Code': '11', 'coordonnees': ['[43.0542733, 2.512471457499548]'], 'temperatures': 5}, {'Code': '11', 'coordonnees': ['[43.0542733, 2.512471457499548]'], 'temperatures': 5}, {'Code': '11', 'coordonnees': ['[43.0542733, 2.512471457499548]'], 'temperatures': 5}, {'Code': '12', 'coordonnees': ['[44.315857449999996, 2.5065697302419823]'], 'temperatures': 5}, {'Code': '13', 'coordonnees': ['[43.5424182, 5.034323560504859]'], 'temperatures': 5}, {'Code': '14', 'coordonnees': ['[49.09076485, -0.24139505722798021]'], 'temperatures': 5}, {'Code': '16', 'coordonnees': ['[45.6667902, 0.09730504409848517]'], 'temperatures': 5}, {'Code': '16', 'coordonnees': ['[45.6667902, 0.09730504409848517]'], 'temperatures': 5}, {'Code': '17', 'coordonnees': ['[45.73022675, -0.7212875872563794]'], 'temperatures': 5}, {'Code': '17', 'coordonnees': ['[45.73022675, -0.7212875872563794]'], 'temperatures': 5}, {'Code': '17', 'coordonnees': ['[45.73022675, -0.7212875872563794]'], 'temperatures': 5}, {'Code': '17', 'coordonnees': ['[45.73022675, -0.7212875872563794]'], 'temperatures': 5}, {'Code': '17', 'coordonnees': ['[45.73022675, -0.7212875872563794]'], 'temperatures': 5}, {'Code': '17', 'coordonnees': ['[45.73022675, -0.7212875872563794]'], 'temperatures': 5}, {'Code': '19', 'coordonnees': ['[45.342904700000005, 1.8176424406120555]'], 'temperatures': 5}, {'Code': '19', 'coordonnees': ['[45.342904700000005, 1.8176424406120555]'], 'temperatures': 5}, {'Code': '2', 'coordonnees': [], 'temperatures': 5}, {'Code': '2', 'coordonnees': [], 'temperatures': 5}, {'Code': '22', 'coordonnees': ['[48.461487700000006, -2.751432791068642]'], 'temperatures': 5}, {'Code': '22', 'coordonnees': ['[48.461487700000006, -2.751432791068642]'], 'temperatures': 5}, {'Code': '22', 'coordonnees': ['[48.461487700000006, -2.751432791068642]'], 'temperatures': 5}, {'Code': '24', 'coordonnees': ['[45.14291985, 0.6321258058651044]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '25', 'coordonnees': ['[47.06699155, 6.235622772820445]'], 'temperatures': 5}, {'Code': '26', 'coordonnees': ['[44.72953475, 5.204637164536667]'], 'temperatures': 5}, {'Code': '26', 'coordonnees': ['[44.72953475, 5.204637164536667]'], 'temperatures': 5}, {'Code': '28', 'coordonnees': ['[48.4474102, 1.3998820185020766]'], 'temperatures': 5}, {'Code': '28', 'coordonnees': ['[48.4474102, 1.3998820185020766]'], 'temperatures': 5}, {'Code': '29', 'coordonnees': ['[48.24511525, -4.044090245241742]'], 'temperatures': 5}, {'Code': '30', 'coordonnees': ['[43.95995, 4.297637002377168]'], 'temperatures': 5}, {'Code': '30', 'coordonnees': ['[43.95995, 4.297637002377168]'], 'temperatures': 5}, {'Code': '30', 'coordonnees': ['[43.95995, 4.297637002377168]'], 'temperatures': 5}, {'Code': '30', 'coordonnees': ['[43.95995, 4.297637002377168]'], 'temperatures': 5}, {'Code': '31', 'coordonnees': ['[43.305454600000004, 0.9716791701901577]'], 'temperatures': 5}, {'Code': '31', 'coordonnees': ['[43.305454600000004, 0.9716791701901577]'], 'temperatures': 5}, {'Code': '31', 'coordonnees': ['[43.305454600000004, 0.9716791701901577]'], 'temperatures': 5}, {'Code': '33', 'coordonnees': ['[44.883745950000005, -0.6051264440438711]'], 'temperatures': 5}, {'Code': '34', 'coordonnees': ['[43.591422, 3.3553309364095925]'], 'temperatures': 5}, {'Code': '34', 'coordonnees': ['[43.591422, 3.3553309364095925]'], 'temperatures': 5}, {'Code': '34', 'coordonnees': ['[43.591422, 3.3553309364095925]'], 'temperatures': 5}, {'Code': '34', 'coordonnees': ['[43.591422, 3.3553309364095925]'], 'temperatures': 5}, {'Code': '38', 'coordonnees': ['[45.28979315, 5.634382477386232]'], 'temperatures': 5}, {'Code': '38', 'coordonnees': ['[45.28979315, 5.634382477386232]'], 'temperatures': 5}, {'Code': '38', 'coordonnees': ['[45.28979315, 5.634382477386232]'], 'temperatures': 5}, {'Code': '38', 'coordonnees': ['[45.28979315, 5.634382477386232]'], 'temperatures': 5}, {'Code': '38', 'coordonnees': ['[45.28979315, 5.634382477386232]'], 'temperatures': 5}, {'Code': '38', 'coordonnees': ['[45.28979315, 5.634382477386232]'], 'temperatures': 5}, {'Code': '39', 'coordonnees': ['[46.783362499999996, 5.783285726354901]'], 'temperatures': 5}, {'Code': '40', 'coordonnees': ['[44.00996945, -0.6433872354467377]'], 'temperatures': 5}, {'Code': '41', 'coordonnees': ['[47.65977515, 1.297183525390464]'], 'temperatures': 5}, {'Code': '41', 'coordonnees': ['[47.65977515, 1.297183525390464]'], 'temperatures': 5}, {'Code': '41', 'coordonnees': ['[47.65977515, 1.297183525390464]'], 'temperatures': 5}, {'Code': '42', 'coordonnees': ['[45.75385355, 4.045473682551104]'], 'temperatures': 5}, {'Code': '42', 'coordonnees': ['[45.75385355, 4.045473682551104]'], 'temperatures': 5}, {'Code': '42', 'coordonnees': ['[45.75385355, 4.045473682551104]'], 'temperatures': 5}, {'Code': '42', 'coordonnees': ['[45.75385355, 4.045473682551104]'], 'temperatures': 5}, {'Code': '43', 'coordonnees': ['[45.085724850000005, 3.833826117673291]'], 'temperatures': 5}, {'Code': '43', 'coordonnees': ['[45.085724850000005, 3.833826117673291]'], 'temperatures': 5}, {'Code': '43', 'coordonnees': ['[45.085724850000005, 3.833826117673291]'], 'temperatures': 5}, {'Code': '43', 'coordonnees': ['[45.085724850000005, 3.833826117673291]'], 'temperatures': 5}, {'Code': '44', 'coordonnees': ['[47.34816145, -1.8727461214619257]'], 'temperatures': 5}, {'Code': '44', 'coordonnees': ['[47.34816145, -1.8727461214619257]'], 'temperatures': 5}, {'Code': '45', 'coordonnees': ['[47.91387245, 2.3075036458463853]'], 'temperatures': 5}, {'Code': '46', 'coordonnees': ['[44.624991800000004, 1.6657742169753669]'], 'temperatures': 5}, {'Code': '47', 'coordonnees': ['[44.3691703, 0.45391575832487524]'], 'temperatures': 5}, {'Code': '48', 'coordonnees': ['[44.5425706, 3.521114648333333]'], 'temperatures': 5}, {'Code': '50', 'coordonnees': ['[49.091895199999996, -1.2454952394090721]'], 'temperatures': 5}, {'Code': '53', 'coordonnees': ['[48.1507819, -0.6491273812007092]'], 'temperatures': 5}, {'Code': '54', 'coordonnees': ['[48.95596825, 5.987038299756556]'], 'temperatures': 5}, {'Code': '54', 'coordonnees': ['[48.95596825, 5.987038299756556]'], 'temperatures': 5}, {'Code': '54', 'coordonnees': ['[48.95596825, 5.987038299756556]'], 'temperatures': 5}, {'Code': '56', 'coordonnees': ['[47.825981150000004, -2.7633492695588253]'], 'temperatures': 5}, {'Code': '56', 'coordonnees': ['[47.825981150000004, -2.7633492695588253]'], 'temperatures': 5}, {'Code': '57', 'coordonnees': ['[49.0207259, 6.538035170357949]'], 'temperatures': 5}, {'Code': '57', 'coordonnees': ['[49.0207259, 6.538035170357949]'], 'temperatures': 5}, {'Code': '57', 'coordonnees': ['[49.0207259, 6.538035170357949]'], 'temperatures': 5}, {'Code': '57', 'coordonnees': ['[49.0207259, 6.538035170357949]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '59', 'coordonnees': ['[50.52896715, 3.0883523694464854]'], 'temperatures': 5}, {'Code': '60', 'coordonnees': ['[49.41205455, 2.406487846905477]'], 'temperatures': 5}, {'Code': '60', 'coordonnees': ['[49.41205455, 2.406487846905477]'], 'temperatures': 5}, {'Code': '61', 'coordonnees': ['[48.57605325, 0.04466171759588161]'], 'temperatures': 5}, {'Code': '63', 'coordonnees': ['[45.7715343, 3.0839934206717934]'], 'temperatures': 5}, {'Code': '63', 'coordonnees': ['[45.7715343, 3.0839934206717934]'], 'temperatures': 5}, {'Code': '63', 'coordonnees': ['[45.7715343, 3.0839934206717934]'], 'temperatures': 5}, {'Code': '63', 'coordonnees': ['[45.7715343, 3.0839934206717934]'], 'temperatures': 5}, {'Code': '63', 'coordonnees': ['[45.7715343, 3.0839934206717934]'], 'temperatures': 5}, {'Code': '63', 'coordonnees': ['[45.7715343, 3.0839934206717934]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '64', 'coordonnees': ['[43.18718655, -0.728247400084667]'], 'temperatures': 5}, {'Code': '65', 'coordonnees': ['[43.1437925, 0.15866611287926924]'], 'temperatures': 5}, {'Code': '65', 'coordonnees': ['[43.1437925, 0.15866611287926924]'], 'temperatures': 5}, {'Code': '65', 'coordonnees': ['[43.1437925, 0.15866611287926924]'], 'temperatures': 5}, {'Code': '66', 'coordonnees': ['[42.625894, 2.5065089946931507]'], 'temperatures': 5}, {'Code': '66', 'coordonnees': ['[42.625894, 2.5065089946931507]'], 'temperatures': 5}, {'Code': '66', 'coordonnees': ['[42.625894, 2.5065089946931507]'], 'temperatures': 5}, {'Code': '66', 'coordonnees': ['[42.625894, 2.5065089946931507]'], 'temperatures': 5}, {'Code': '67', 'coordonnees': ['[48.5991783, 7.533672856882669]'], 'temperatures': 5}, {'Code': '67', 'coordonnees': ['[48.5991783, 7.533672856882669]'], 'temperatures': 5}, {'Code': '68', 'coordonnees': ['[47.8654746, 7.231543347579764]'], 'temperatures': 5}, {'Code': '68', 'coordonnees': ['[47.8654746, 7.231543347579764]'], 'temperatures': 5}, {'Code': '68', 'coordonnees': ['[47.8654746, 7.231543347579764]'], 'temperatures': 5}, {'Code': '68', 'coordonnees': ['[47.8654746, 7.231543347579764]'], 'temperatures': 5}, {'Code': '68', 'coordonnees': ['[47.8654746, 7.231543347579764]'], 'temperatures': 5}, {'Code': '68', 'coordonnees': ['[47.8654746, 7.231543347579764]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '69', 'coordonnees': ['[45.8802348, 4.564533629559522]'], 'temperatures': 5}, {'Code': '71', 'coordonnees': ['[46.6557086, 4.55855481835173]'], 'temperatures': 5}, {'Code': '72', 'coordonnees': ['[48.026928749999996, 0.2538217482247317]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '73', 'coordonnees': ['[45.494895150000005, 6.384660381375652]'], 'temperatures': 5}, {'Code': '74', 'coordonnees': ['[46.068820849999994, 6.344536991587102]'], 'temperatures': 5}, {'Code': '74', 'coordonnees': ['[46.068820849999994, 6.344536991587102]'], 'temperatures': 5}, {'Code': '74', 'coordonnees': ['[46.068820849999994, 6.344536991587102]'], 'temperatures': 5}, {'Code': '74', 'coordonnees': ['[46.068820849999994, 6.344536991587102]'], 'temperatures': 5}, {'Code': '74', 'coordonnees': ['[46.068820849999994, 6.344536991587102]'], 'temperatures': 5}, {'Code': '75', 'coordonnees': ['[48.8534951, 2.3483915]'], 'temperatures': 5}, {'Code': '75', 'coordonnees': ['[48.8534951, 2.3483915]'], 'temperatures': 5}, {'Code': '76', 'coordonnees': ['[49.66323745, 0.9401133910609153]'], 'temperatures': 5}, {'Code': '76', 'coordonnees': ['[49.66323745, 0.9401133910609153]'], 'temperatures': 5}, {'Code': '77', 'coordonnees': ['[48.61902069999999, 3.0418157506708345]'], 'temperatures': 5}, {'Code': '78', 'coordonnees': ['[48.76203735, 1.8871375621264361]'], 'temperatures': 5}, {'Code': '79', 'coordonnees': ['[46.53914, -0.29947849341978416]'], 'temperatures': 5}, {'Code': '80', 'coordonnees': ['[49.96894815, 2.373885538932255]'], 'temperatures': 5}, {'Code': '81', 'coordonnees': ['[43.7921741, 2.133964772269535]'], 'temperatures': 5}, {'Code': '81', 'coordonnees': ['[43.7921741, 2.133964772269535]'], 'temperatures': 5}, {'Code': '82', 'coordonnees': ['[44.080656000000005, 1.2050632958700225]'], 'temperatures': 5}, {'Code': '83', 'coordonnees': ['[43.4173592, 6.2664620128919]'], 'temperatures': 5}, {'Code': '83', 'coordonnees': ['[43.4173592, 6.2664620128919]'], 'temperatures': 5}, {'Code': '84', 'coordonnees': ['[43.993864349999996, 5.1818898389002355]'], 'temperatures': 5}, {'Code': '84', 'coordonnees': ['[43.993864349999996, 5.1818898389002355]'], 'temperatures': 5}, {'Code': '85', 'coordonnees': ['[46.67577325, -1.29144634801388]'], 'temperatures': 5}, {'Code': '85', 'coordonnees': ['[46.67577325, -1.29144634801388]'], 'temperatures': 5}, {'Code': '85', 'coordonnees': ['[46.67577325, -1.29144634801388]'], 'temperatures': 5}, {'Code': '85', 'coordonnees': ['[46.67577325, -1.29144634801388]'], 'temperatures': 5}, {'Code': '86', 'coordonnees': ['[46.612116549999996, 0.4654070096639711]'], 'temperatures': 5}, {'Code': '87', 'coordonnees': ['[45.91901925, 1.203176771876291]'], 'temperatures': 5}, {'Code': '88', 'coordonnees': ['[48.16378605, 6.382071173595532]'], 'temperatures': 5}, {'Code': '88', 'coordonnees': ['[48.16378605, 6.382071173595532]'], 'temperatures': 5}, {'Code': '88', 'coordonnees': ['[48.16378605, 6.382071173595532]'], 'temperatures': 5}, {'Code': '90', 'coordonnees': ['[47.62923095, 6.899301156710882]'], 'temperatures': 5}, {'Code': '91', 'coordonnees': ['[48.53034015, 2.239291805668168]'], 'temperatures': 5}, {'Code': '91', 'coordonnees': ['[48.53034015, 2.239291805668168]'], 'temperatures': 5}, {'Code': '91', 'coordonnees': ['[48.53034015, 2.239291805668168]'], 'temperatures': 5}]
def coordinate_temperature(coordonees):
    """
# Dans cet exemple nous allons utiliser le service météo du Meteorologisk institutt de Norvège
# (api.met.no/weatherapi is an interface to a selection of data produced by MET Norway)
# url: https://api.met.no/weatherapi/locationforecast/2.0/documentation

# Grâce à Google Maps, nous trouvons que les coordonnées de l'IUT à Mont de Marsan sont
# latitude 43.88566272770907, longitude -0.5092243304975015
#
# Ce qui nous donne l'URL suivante pour accéder aux prévisions météo au format JSON:
# https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=43.88566272770907&lon=-0.5092243304975015
# Fetch data from URL
    """
    latitude = coordonees[0]
    longitude = coordonees[1]
    headers = {'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:35.0) Gecko/20100101 Firefox/35.0',
            'Cache-Control': 'no-cache, no-store, must-revalidate', 'Pragma': 'no-cache', 'Expires': '0'}
    url = requests.get(f"https://api.met.no/weatherapi/locationforecast/2.0/compact?lat={latitude}7&lon={longitude}", headers=headers)
    text = url.text

    # Get JSON data
    data = json.loads(text)
    #print(data)

    # Process JSON data
    units = data["properties"]["meta"]["units"]
    weather = data["properties"]["timeseries"][0]["data"]["instant"]["details"]  
    return weather

def get_department(commune_name):
    geolocator = Nominatim(user_agent="my-app")
    location = geolocator.geocode(commune_name + ", France")
    if location:
        return "".join(re.findall(r'-?\d+',location.raw['display_name']))[:2]
    else:
        return None

read = []

global departements_numeros
departements_numeros = []

with open('coordonnees_departements.csv','r') as f:
    lect = csv.DictReader(f,delimiter=',')
    try:
        for row in lect:
            departements_numeros.append(row)
    except:
        pass

dico_etats_meteos = []

with open('donnees_cameras.csv','r',encoding="ISO-8859-1") as f:
    read = csv.DictReader(f,fieldnames=['lien','departement'])
    # DETERMINATION DE L'ÉTAT MÉTÉO
    for ligne in read: 
        if ligne['departement'] != 'NULL' and 'webcam_error.png' not in ligne['lien']:
            url = ligne['lien']
            try: 
                response = requests.get(url)
                img = Image.open(BytesIO(response.content))
                #img.save("webcam_image.jpg", "JPEG") 
                open_cv_image = numpy.array(img) 
                # Convert RGB to BGR 
            except:
                print("probleme de recuperation d'image")
                continue # on skip l'iteration actuelle
            no_departement = re.findall(r'\d+', ligne['departement'])
            if len(no_departement) == 1:
                no_departement = ''.join(no_departement)
            else:
                try : 
                    # si on a pas le~numéo, essayer de geopy le nom de la commune pour trouver
                    no_departement = get_department(ligne['departement'][ligne['departement'].index('de'):ligne['departement'].index('(')])
                    print('utilisation reussie de geopy',ligne['departement'][ligne['departement'].index('de'):ligne['departement'].index('(')],'numero determiné',no_departement)
                except:
                    # probleme avec Geopy : numero sauté
                    continue
            global indice
            try : 
                # INDICE DE METEO
                open_cv_image = open_cv_image[:, :, ::-1].copy() 
                image_tronquee = tronquer(open_cv_image)
                indice = determine_weather_index(open_cv_image)
            except :
                print("probleme avec l'indexation de l'image") 
                indice = 'NULL'
            
            if no_departement != None :   
                    coordonnes = sum([d['coordonnee'].strip('][').split(', ') for d in departements_numeros if d['Code'] == no_departement],[])
                    coordonnes = [float(i) for i in coordonnes]
                    try :
                        meteo = coordinate_temperature(coordonnes)
                        dico_etats_meteos.append({'Code':no_departement,'coordonnees':coordonnes,'indice':indice,'temperature':meteo['air_temperature'],'humidite':meteo['relative_humidity'],'weather':''})
                    except IndexError:
                        print('PROBLEME')
            #print(dico_etats_meteos)

dico_etats_meteos = sorted(dico_etats_meteos,key=lambda dico_etats_meteos: dico_etats_meteos['Code'])

with open('donnes_a_classifie.csv','w') as f:
    # creer / actualiser un csv pour létat météo d'un departement
    lect = csv.DictWriter(f,fieldnames=['Code','coordonnees','indice','temperature','humidite','weather'])
    lect.writeheader()
    lect.writerows(dico_etats_meteos)